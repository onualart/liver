---
title: "pipeline"
author: "Oriol Nualart Mundó"
date: "12/4/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## 1. Preparació de les dades.


Abans que res, el primer que hem fet és descarregar els arxius .CEL i preparar l'arxiu *targets*. Aquests arxius els hem posat al subdirectori *data* del repositori.


Llegim l'arxiu targets.csv.

```{r}
targets <- read.csv2("./data/targets.csv", header = TRUE, sep = ";")
```


Llegim els arxius .CEL per guardar tota la informació a l'*ExpressionSet* "rawData".

```{r}
library(oligo)
celFiles <- list.celfiles("./data", full.names = TRUE)
library(Biobase)
my.targets <-read.AnnotatedDataFrame(file.path("./data","targets.csv"),
                                     header = TRUE, row.names = 1, 
                                     sep=";") 
rawData <- read.celfiles(celFiles, phenoData = my.targets)
```


Canviem el nom llarg de les mostres pel ShotrName.

```{r}
my.targets@data$ShortName->rownames(pData(rawData))
colnames(rawData) <-rownames(pData(rawData))
```



## 2. Control de qualitat de les dades crues.

Apliquem els controls de qualitat del paquet *arrayQualityMetrics*.

```{r}
library(arrayQualityMetrics)
arrayQualityMetrics(rawData, intgroup = c("Diet", "ShortName"), outdir = "qcRaw",
                    force = TRUE)
```

Resum del control de qualitat. (Nota: la imatge de la taula és una captura de la pàgina html generada, ja que la funció *arrayQualityMetrics* no la crea automàticament.)

![Taula resum del control de qualitat de les dades crues](extra_pics/mdRaw.png)

Heatmap generat pel control de qualitat:

![Heatmap de les dades crues](qcRaw/hm.png)



Per treure la mostra NC.5, creem una nova carpeta "moddata", on posem l'arxiu targets modificat i tots els arxius .CEL excepte el que correspon a NC.5. Tot seguit tornem a carregar les dades, aquesta vegada des de "moddata".

```{r}
targets <- read.csv2("./moddata/targets.csv", header = TRUE, sep = ";")
```


```{r}
library(oligo)
celFiles <- list.celfiles("./moddata", full.names = TRUE)
library(Biobase)
my.targets <-read.AnnotatedDataFrame(file.path("./moddata","targets.csv"),
                                     header = TRUE, row.names = 1, 
                                     sep=";") 
rawData <- read.celfiles(celFiles, phenoData = my.targets)
```

```{r}
my.targets@data$ShortName->rownames(pData(rawData))
colnames(rawData) <-rownames(pData(rawData))
```

Repetim el control de qualitat.

```{r}
arrayQualityMetrics(rawData, intgroup = c("Diet", "ShortName"), outdir = "qcMod",
                    force = TRUE)
```


![Taula resum del control de qualitat de les dades havent tret la mostra NC.5](extra_pics/mdMod.png)


![Heatmap de les dades sense NC.5](qcMod/hm.png)



## 3. Normalització.

Utilitzem el mètode Robust Multichip Analysis per fer la correcció del soroll de fons, normalitzar i sumaritzar les dades.

```{r}
library(oligo)
normData <- rma(rawData)
```


## 4. Control de qualitat de les dades normalitzades.


```{r}
arrayQualityMetrics(normData, intgroup = c("Diet", "ShortName"), outdir = "qcNorm",
                    force = TRUE)
```

![Taula resum del control de qualitat de les dades normalitzades](extra_pics/mdNorm.png)


![Heatmap de les dades normalitzades](qcNorm/hm.png)



## 5. Filtratge no específic.

Filtrem els gens menys variables.

```{r}
library(genefilter)
library(mogene20sttranscriptcluster.db)
annotation(normData) <- "mogene20sttranscriptcluster.db"
filtered <- nsFilter(normData, 
                     require.entrez = TRUE, remove.dupEntrez = TRUE,
                     var.filter=TRUE, var.func=IQR, var.cutoff=0.5, 
                     filterByQuantile=TRUE, feature.exclude = "^AFFX")
filtData <- filtered$eset
```


```{r}
print(filtered$filter.log)
```


Guardem les dades un cop normalitzades i un cop filtrades.

```{r}
write.csv(exprs(normData), file="./results/normData.csv")
write.csv(exprs(filtData), file="./results/filtData.csv")
save(normData, filtData, file="./results/NormFiltData.Rda")
```



## 6. Identificació de gens diferencialment expressats.

Matriu de disseny.

```{r}
library(limma)
designMat<- model.matrix(~0+Diet, pData(filtData))
colnames(designMat) <- c("CPT", "HFD", "NC")
print(designMat)
```


Matriu de contrastos.

```{r}
contMat <- makeContrasts (HFDvsCPT = CPT-HFD,
                          NCvsHFD = HFD-NC,
                          NCvsCPT = CPT-NC,
                          levels=designMat)
print(contMat)
```


Estimació del model.

```{r}
library(limma)
fit<-lmFit(filtData, designMat)
```


Estimació dels contrastos.

```{r}
fit.main<-contrasts.fit(fit, contMat)
```


Regularització de la variança.

```{r}
fit.main<-eBayes(fit.main)
```

Guardem els resultats en un arxiu.

```{r}
save(fit.main, file="./results/liver.fit.main.Rda")
```


Exploració dels gens més diferencialment expressats en cada comparació.

```{r}
top_HFDvsCPT <- topTable (fit.main, number=nrow(fit.main), coef="HFDvsCPT",
                               adjust="fdr") 
head(top_HFDvsCPT)
```


```{r}
top_NCvsHFD <- topTable (fit.main, number=nrow(fit.main), coef="NCvsHFD", adjust="fdr") 
head(top_NCvsHFD)
```


```{r}
top_NCvsCPT <- topTable (fit.main, number=nrow(fit.main), coef="NCvsCPT",
                               adjust="fdr") 
head(top_NCvsCPT)
```


## 7. Anotació dels resultats.

Funció *annotatedTopTable*.

```{r}
annotatedTopTable <- function(topTab, anotPackage)
{
 topTab <- cbind(PROBEID=rownames(topTab), topTab)
 myProbes <- rownames(topTab)
 thePackage <- eval(parse(text = anotPackage))
 geneAnots <- select(thePackage, myProbes, c("SYMBOL", "ENTREZID", "GENENAME"))
 annotatedTopTab<- merge(x=geneAnots, y=topTab, by.x="PROBEID", by.y="PROBEID")
return(annotatedTopTab)
}
```


Generació de les anotacions.

```{r}
library(mogene20sttranscriptcluster.db)

annot_HFDvsCPT <- annotatedTopTable(top_HFDvsCPT,
                                    anotPackage="mogene20sttranscriptcluster.db")
annot_NCvsHFD <- annotatedTopTable(top_NCvsHFD,
                                   anotPackage="mogene20sttranscriptcluster.db")
annot_NCvsCPT <- annotatedTopTable(top_NCvsCPT,
                                   anotPackage="mogene20sttranscriptcluster.db")
```

Guardem els *data frames* obtinguts en arxius .csv.

```{r}
write.csv(annot_HFDvsCPT, file="./results/annot_HFDvsCPT.csv")
write.csv(annot_NCvsHFD, file="./results/annot_NCvsHFD.csv")
write.csv(annot_NCvsCPT, file="./results/annot_NCvsCPT.csv")
```


Volcano plots.

```{r}
geneNames <- select(mogene20sttranscriptcluster.db, rownames(fit.main), c("GENENAME"))
geneNames <- geneNames$GENENAME
opt <- par(cex.lab = 0.7)
```


```{r}
volcanoplot(fit.main, coef=1, highlight=10, names=geneNames,
main=paste("Gens diferencialment expressats en el contrast",
colnames(contMat)[1], sep="\n"))
abline(v=c(-1,1))
par(opt)
```


```{r}
volcanoplot(fit.main, coef=2, highlight=10, names=geneNames,
main=paste("Gens diferencialment expressats en el contrast",
colnames(contMat)[2], sep="\n"))
abline(v=c(-1,1))
par(opt)
```


```{r}
volcanoplot(fit.main, coef=3, highlight=10, names=geneNames,
main=paste("Gens diferencialment expressats en el contrast",
colnames(contMat)[3], sep="\n"))
abline(v=c(-1,1))
par(opt)
```


Selecció dels gens diferencialment expressats.

```{r}
library(limma)
res <- decideTests(fit.main, method="separate", adjust.method="fdr", p.value=0.1, lfc=0.75)
sum.res.rows <- apply(abs(res), 1, sum)
res.selected <- res[sum.res.rows!=0,]
```


*Heatmap*

```{r}
library(gplots)

genesHeatmap <- rownames(res.selected)
heatData <- exprs(filtData)[rownames(exprs(filtData)) %in% genesHeatmap,]
geneNames <- select(mogene20sttranscriptcluster.db, rownames(heatData), c("GENENAME"))
GENENAMES<- geneNames$GENENAME
rownames(heatData) <- GENENAMES
my_palette <- colorRampPalette(c("blue3", "gold"))(n = 299)
```

```{r}
heatmap.2(heatData,
          Rowv = TRUE,
          Colv = TRUE,
          dendrogram = "column",
          main = "Gens diferencialment expressats \n FDR < 0,1, logFC >=0.75",
          scale = "row",
          col = my_palette,
          sepcolor = "white",
          sepwidth = c(0.05,0.05),
          cexRow = 0.5,
          cexCol = 0.9,
          key = TRUE,
          keysize = 1.5,
          density.info = "histogram",
          ColSideColors = c(rep("firebrick2",4), rep("dodgerblue3",5),
                            rep("limegreen",5)),
          tracecol = NULL,
          srtCol = 30)
```


## 8. Comparació entre comparacions.

Número de gens diferencialment expressats en cada comparació.

```{r}
print(summary(res))
```


Diagrama de Venn.

```{r}
vennDiagram (res.selected[,1:3], cex=0.9)
title("Gens diferencialment expressats segons cada comparació.")
```


## 9. Anàlisi de significació biològica.

Generació del llistat d'identificadors *Entrez*.

```{r}
genesHFDvsCPT <- top_HFDvsCPT["adj.P.Val"]<0.25
IDsHFDvsCPT <- rownames(top_HFDvsCPT)[genesHFDvsCPT]
EntrezHFDvsCPT <- select(mogene20sttranscriptcluster.db, IDsHFDvsCPT, c("ENTREZID"))
EntrezHFDvsCPT <- EntrezHFDvsCPT$ENTREZID

genesNCvsHFD <- top_NCvsHFD["adj.P.Val"]<0.25
IDsNCvsHFD <- rownames(top_NCvsHFD)[genesNCvsHFD]
EntrezNCvsHFD <- select(mogene20sttranscriptcluster.db, IDsNCvsHFD, c("ENTREZID"))
EntrezNCvsHFD <- EntrezNCvsHFD$ENTREZID

genesNCvsCPT <- top_NCvsCPT["adj.P.Val"]<0.25
IDsNCvsCPT <- rownames(top_NCvsCPT)[genesNCvsCPT]
EntrezNCvsCPT <- select(mogene20sttranscriptcluster.db, IDsNCvsCPT, c("ENTREZID"))
EntrezNCvsCPT <- EntrezNCvsCPT$ENTREZID

selectedIDs <- list(EntrezHFDvsCPT, EntrezNCvsHFD, EntrezNCvsCPT)
names(selectedIDs) <- c("HFDvsCPT", "NCvsHFD", "NCvsCPT")
```

```{r}
sapply(selectedIDs, length)
```


Genergeneració de la llista dels gens de ratolí amb anotacions a GO i a KEGG.

```{r}
library(org.Mm.eg.db)
mapped_genes2GO <- mappedkeys(org.Mm.egGO)
mapped_genes2KEGG <- mappedkeys(org.Mm.egPATH)
mapped_genes <- union(mapped_genes2GO , mapped_genes2KEGG)
```


Anàlisi de significació biològica.


```{r}
library(ReactomePA)
listOfData <- selectedIDs[1:3]
comparisonsNames <- names(listOfData)

for (i in 1:length(listOfData)){
        genesIn <- listOfData[[i]]
        comparison <- comparisonsNames[i]
        enrich.result <- enrichPathway(gene = genesIn,
                                       pvalueCutoff = 0.05,
                                       readable = T,
                                       pAdjustMethod = "BH",
                                       organism = "mouse",
                                       universe = mapped_genes)
   
        cat("##################################")
        cat("\nComparison: ", comparison,"\n")
        print(head(enrich.result))
        
        if (length(rownames(enrich.result@result)) != 0) {
                write.csv(as.data.frame(enrich.result), 
                          file = paste0("./results/", "ReactomePA.Results.", comparison,
                                        ".csv"),
                          row.names = FALSE)
                
                png(file=paste0("./results/","ReactomePABarplot.",comparison,".png"))
                print(barplot(enrich.result, showCategory = 15, font.size = 4, 
                              title = paste0("Reactome Pathway Analysis for ",
                                             comparison, ". Barplot")))
                dev.off()
                
                png(file = paste0("./results/","ReactomePAcnetplot.",comparison,".png"))
                print(cnetplot(enrich.result, categorySize = "geneNum",
                               schowCategory = 15, vertex.label.cex = 0.75))
                dev.off()
        }
}
```





## 4. Resultats.

![Barplot de HFD vs CPT](results/ReactomePABarplot.HFDvsCPT.png)


![Gràfic de ret de HFD vs CPT](results/ReactomePAcnetplot.HFDvsCPT.png)


![Barplot de NC vs HFD](results/ReactomePABarplot.NCvsHFD.png)


![Gràfic de ret de NC vs HFD](results/ReactomePAcnetplot.NCvsHFD.png)



![Barplot de NC vs CPT](results/ReactomePABarplot.NCvsCPT.png)


![Gràfic de ret de NC vs CPT](results/ReactomePAcnetplot.NCvsCPT.png)






